import streamlit as st
import google.generativeai as genai
from gtts import gTTS
import os, io, time

# --- 1. å…¨å°è¡Œæ”¿å€è³‡æ–™åº« (2026 å®Œæ•´ç‰ˆ) ---
TAIWAN_DISTRICTS = {
    "å°ä¸­å¸‚": ["å¤§é‡Œå€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "å¤§è‚šå€"],
    "å°åŒ—å¸‚": ["ä¸­æ­£å€", "è¬è¯å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "ä¿¡ç¾©å€", "å…§æ¹–å€", "å—æ¸¯å€", "å£«æ—å€", "åŒ—æŠ•å€", "æ–‡å±±å€"],
    "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "ç‘èŠ³å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
    "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
    "å°å—å¸‚": ["ä¸­è¥¿å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å¹³å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
    "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
    "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
    "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "ç¾…æ±é®", "è˜‡æ¾³é®", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "å†¬å±±é„‰", "äº”çµé„‰", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "å—æ¾³é„‰"],
    "æ¡ƒåœ’ç¸£": ["å·²ä½µå…¥æ¡ƒåœ’å¸‚"],
    "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
    "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
    "è‹—æ —ç¸£": ["è‹—æ —å¸‚", "é ­ä»½å¸‚", "ç«¹å—é®", "å¾Œé¾é®", "é€šéœ„é®", "è‹‘è£¡é®", "å“è˜­é®", "é€ æ©‹é„‰", "è¥¿æ¹–é„‰", "é ­å±‹é„‰", "å…¬é¤¨é„‰", "éŠ…é‘¼é„‰", "ä¸‰ç¾©é„‰", "å¤§æ¹–é„‰", "ç…æ½­é„‰", "ä¸‰ç£é„‰", "å—åº„é„‰", "æ³°å®‰é„‰"],
    "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "é¹¿æ¸¯é®", "å’Œç¾é®", "ç·šè¥¿é„‰", "ä¼¸æ¸¯é„‰", "ç¦èˆˆé„‰", "ç§€æ°´é„‰", "èŠ±å£‡é„‰", "èŠ¬åœ’é„‰", "å“¡æ—å¸‚", "æºªæ¹–é®", "ç”°ä¸­é®", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "åŸ”å¿ƒé„‰", "æ°¸é–é„‰", "ç¤¾é ­é„‰", "äºŒæ°´é„‰", "åŒ—æ–—é®", "äºŒæ—é®", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "èŠ³è‹‘é„‰", "å¤§åŸé„‰", "ç«¹å¡˜é„‰", "æºªå·é„‰"],
    "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "åŸ”é‡Œé®", "è‰å±¯é®", "ç«¹å±±é®", "é›†é›†é®", "åé–“é„‰", "é¹¿è°·é„‰", "ä¸­å¯®é„‰", "é­šæ± é„‰", "åœ‹å§“é„‰", "æ°´é‡Œé„‰", "ä¿¡ç¾©é„‰", "ä»æ„›é„‰"],
    "é›²æ—ç¸£": ["æ–—å…­å¸‚", "æ–—å—é®", "è™å°¾é®", "è¥¿èºé®", "åœŸåº«é®", "åŒ—æ¸¯é®", "å¤å‘é„‰", "å¤§åŸ¤é„‰", "è¿æ¡é„‰", "æ—å…§é„‰", "äºŒå´™é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ±å‹¢é„‰", "è¤’å¿ é„‰", "å°è¥¿é„‰", "å…ƒé•·é„‰", "å››æ¹–é„‰", "å£æ¹–é„‰", "æ°´æ—é„‰"],
    "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
    "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚", "æœ´å­å¸‚", "å¸ƒè¢‹é®", "å¤§æ—é®", "æ°‘é›„é„‰", "æºªå£é„‰", "æ–°æ¸¯é„‰", "å…­è…³é„‰", "æ±çŸ³é„‰", "ç¾©ç«¹é„‰", "é¹¿è‰é„‰", "æ°´ä¸Šé„‰", "ä¸­åŸ”é„‰", "ç«¹å´é„‰", "æ¢…å±±é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±é„‰"],
    "å±æ±ç¸£": ["å±æ±å¸‚", "æ½®å·é®", "æ±æ¸¯é®", "æ†æ˜¥é®", "è¬ä¸¹é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é«˜æ¨¹é„‰", "é¹½åŸ”é„‰", "å…§åŸ”é„‰", "ç«¹ç”°é„‰", "è¬å·’é„‰", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "æ˜¥æ—¥é„‰", "æ‹å¯®é„‰", "æ‹å±±é„‰", "è»ŠåŸé„‰", "æ»¿å·é„‰", "ä¸‰åœ°é–€é„‰", "éœ§è‡ºé„‰", "ç‘ªå®¶é„‰", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "åµŒé ‚é„‰", "æ–°åŸ¤é„‰", "å—å·é„‰", "æ—é‚Šé„‰", "ç‰çƒé„‰", "ä½³å†¬é„‰", "æ–°åœ’é„‰", "æ‹å¯®é„‰", "æ‹å±±é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "ç‰¡ä¸¹é„‰", "è»ŠåŸé„‰", "æ»¿å·é„‰"],
    "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "é³³æ—é®", "ç‰é‡Œé®", "æ–°åŸé„‰", "å‰å®‰é„‰", "å£½è±é„‰", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "å¯Œé‡Œé„‰", "ç§€æ—é„‰", "è¬æ¦®é„‰", "å“æºªé„‰"],
    "å°æ±ç¸£": ["å°æ±å¸‚", "æˆåŠŸé®", "é—œå±±é®", "å‘å—é„‰", "é¹¿é‡é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "å¤§æ­¦é„‰", "ç¶ å³¶é„‰", "æµ·ç«¯é„‰", "å»¶å¹³é„‰", "é‡‘å³°é„‰", "é”ä»é„‰", "è˜­å¶¼é„‰"],
    "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"],
    "é‡‘é–€ç¸£": ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
    "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
}

# --- 2. ç³»çµ±åˆå§‹åŒ– (ä¿®æ­£ 404 æ¨¡å‹å•é¡Œ) ---
st.set_page_config(page_title="æ¨‚ç¦å…¨ç¶²æƒ…å ±ç«™", layout="wide", page_icon="ğŸ¦…")

@st.cache_resource
def init_gemini():
    if "GEMINI_API_KEY" not in st.secrets: return None
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
    try:
        return genai.GenerativeModel(model_name='models/gemini-1.5-flash')
    except:
        return None

model = init_gemini()

# --- 3. ä»‹é¢ä½ˆå±€ ---
st.title("ğŸ¦… æ¨‚ç¦åœ˜éšŠï¼šå…¨ç¶²å¯¦æˆ°åµå¯Ÿç³»çµ±")

col_in, col_res = st.columns([1, 1.2])

with col_in:
    with st.form("pro_form_love_v9"):
        st.subheader("ğŸ“ ç‰©ä»¶ä½ç½®")
        c1_addr, c2_addr = st.columns(2)
        with c1_addr:
            city = st.selectbox("ç¸£å¸‚", options=list(TAIWAN_DISTRICTS.keys()), index=0)
        with c2_addr:
            district = st.selectbox("å€åŸŸ", options=TAIWAN_DISTRICTS[city])
        
        # åœ°å€å…ƒä»¶
        c3_addr, c4_addr = st.columns([3, 1])
        with c3_addr:
            road_name = st.text_input("è·¯è¡—åç¨±", placeholder="ä¾‹å¦‚ï¼šæ±æ¦®")
        with c4_addr:
            road_type = st.selectbox("é¡å‹", ["è·¯", "è¡—", "å¤§é“", "å··"])

        c5, c6, c7, c8 = st.columns(4)
        with c5:
            addr_section = st.text_input("æ®µ", placeholder="ç„¡")
        with c6:
            addr_lane = st.text_input("å··", placeholder="ç„¡")
        with c7:
            addr_alley = st.text_input("å¼„", placeholder="ç„¡")
        with c8:
            addr_num = st.text_input("è™Ÿ", placeholder="å¿…å¡«")

        c_name = st.text_input("æ¡ˆå/ç¤¾å€ (é¸å¡«)", placeholder="ä¾‹å¦‚ï¼šå¤§é™„ä¸­åˆ¥å¢…")
        
        st.divider()
        st.subheader("ğŸ“ å¯¦æˆ°è¦æ ¼ (æ¬„ä½å·²æ¸…ç©º)")
        
        # ä½¿ç”¨ text_input æ¨¡æ“¬æ•¸å­—è¼¸å…¥ï¼Œé”åˆ°ã€Œå®Œå…¨ç©ºç™½ã€çš„æ•ˆæœ
        c1, c2 = st.columns(2)
        with c1:
            c_land = st.text_input("åœ°åª", placeholder="è«‹è¼¸å…¥åªæ•¸")
            c_build_total = st.text_input("ç¸½å»ºåª", placeholder="è«‹è¼¸å…¥åªæ•¸")
            c_age = st.text_input("å±‹é½¡ (å¹´)", placeholder="è«‹è¼¸å…¥å±‹é½¡")
            c_floor = st.text_input("æ¨“å±¤", placeholder="ä¾‹å¦‚ï¼š8/15")
        with c2:
            c_build_inner = st.text_input("å®¤å…§åªæ•¸ (ä¸»+é™„)", placeholder="è«‹è¼¸å…¥åªæ•¸")
            c_width = st.text_input("é¢å¯¬ (ç±³)", placeholder="è«‹è¼¸å…¥é¢å¯¬")
            c_elevator = st.selectbox("é›»æ¢¯", ["æœ‰", "ç„¡"])
            c_road = st.text_input("è·¯å¯¬ (ç±³)", placeholder="è«‹è¼¸å…¥è·¯å¯¬")
            
        c_price = st.text_input("é–‹åƒ¹ (è¬)", placeholder="è«‹è¼¸å…¥åƒ¹æ ¼")
        c_agent = st.text_input("æ‰¿è¾¦äºº", placeholder="æ‚¨çš„å§“å")
        submitted = st.form_submit_button("ğŸš€ å•Ÿå‹•å…¨ç¶²æƒæåµå¯Ÿ")

# --- 4. åˆ†æé‚è¼¯ ---
if submitted and model:
    with col_res:
        with st.spinner("ğŸ•µï¸ æ¨‚ç¦å°å¸«æ­£åœ¨è·¨å¹³å°æ¯”å°ä¸­..."):
            try:
                time.sleep(1.2)
                # åœ°å€çµ„åˆ
                full_addr = f"{city}{district}{road_name}{road_type}"
                if addr_section: full_addr += f"{addr_section}æ®µ"
                if addr_lane: full_addr += f"{addr_lane}å··"
                if addr_alley: full_addr += f"{addr_alley}å¼„"
                full_addr += f"{addr_num}è™Ÿ"
                
                # æ•¸å€¼è½‰æ›
                try:
                    p_land = float(c_land) if c_land else 0
                    p_build = float(c_build_total) if c_build_total else 0
                    p_inner = float(c_build_inner) if c_build_inner else 0
                    p_price = float(c_price) if c_price else 0
                    unit_p = round(p_price / p_build, 2) if p_build > 0 else 0
                    inner_pct = round((p_inner / p_build) * 100, 1) if p_build > 0 else 0
                except:
                    st.error("è«‹ç¢ºèªæ•¸å­—æ¬„ä½è¼¸å…¥æ­£ç¢º")
                    st.stop()
                
                prompt = f"""
                ä½ æ˜¯æ¨‚ç¦å°å¸«ï¼Œè«‹åŸ·è¡Œå…¨ç¶²åˆ†æï¼š
                ç‰©ä»¶ï¼š{full_addr} {c_name}
                è¦æ ¼ï¼šæ¨“å±¤{c_floor}/å±‹é½¡{c_age}/åœ°{p_land}/ç¸½å»º{p_build}/å®¤å…§åªæ•¸{p_inner}/{c_elevator}/é¢å¯¬{c_width}m/è·¯å¯¬{c_road}m
                åƒ¹æ ¼ï¼š{p_price}è¬ (å–®åƒ¹{unit_p}è¬)
                
                1.ã€å…¨ç¶²æ¯”å°ã€‘æœå°‹ä¸­ä¿¡ã€ä¿¡ç¾©ã€æ°¸æ…¶ã€å¤ªå¹³æ´‹ã€591ã€æ¨‚å±‹ç¶²ç›¸ä¼¼ç‰©ä»¶ã€‚
                2.ã€å¯¦åƒ¹è¡Œæƒ…ã€‘è©•ä¼°æœ€æ–°æˆäº¤æ•¸æ“šã€‚
                3.ã€æˆ°è¡“å»ºè­°ã€‘æŒ‡å°{c_agent}è«‡åƒ¹é—œéµã€‚
                * ç¦æ­¢ç”Ÿæˆå‡é€£çµã€‚
                """
                
                res = model.generate_content(prompt).text
                st.subheader(f"ğŸ“Š {c_name if c_name else road_name} æƒ…å ±å ±å‘Š")
                st.markdown(res)
                
                # èªéŸ³
                tts = gTTS(f"å…¨ç¶²åˆ†æå®Œæˆã€‚", lang='zh-tw')
                fp = io.BytesIO(); tts.write_to_fp(fp)
                st.audio(fp, format='audio/mp3')
                
                # æœå°‹çŸ©é™£
                st.divider()
                st.subheader("ğŸŒ å…¨ç¶²å³æ™‚ç›£æ¸¬")
                search_q = f"{full_addr}+{p_inner}åª"
                r1, r2, r3 = st.columns(3)
                with r1:
                    st.link_button("ğŸ  5168 å…¨ç¶²æœå°‹", f"https://house.5168.com.tw/list?keywords={search_q}")
                    st.link_button("ğŸ¢ æ°¸æ…¶æˆ¿ä»²ç¶²", f"https://buy.yungching.com.tw/list?q={search_q}")
                with r2:
                    st.link_button("ğŸ—ï¸ 591 æˆ¿å±‹äº¤æ˜“", f"https://newhouse.591.com.tw/list?keywords={search_q}")
                    st.link_button("ğŸ¤ ä¿¡ç¾©æˆ¿å±‹æœå°‹", f"https://www.sinyi.com.tw/buy/list?search={search_q}")
                with r3:
                    st.link_button("ğŸ“ˆ æ¨‚å±…å¯¦åƒ¹ç™»éŒ„", f"https://www.leju.com.tw/search/search_result?type=1&q={full_addr}")
                    st.link_button("ğŸ” Google æ·±åº¦ç›£æ¸¬", f"https://www.google.com/search?q={search_q}+åœ¨å”®")
                
            except Exception as e:
                st.error(f"åˆ†æå¤±æ•—: {e}")
