import streamlit as st
import google.generativeai as genai

# --- 1. å…¨å° 368 é„‰é®å¸‚å€è³‡æ–™åº« (çµ•å°å®Œæ•´) ---
TAIWAN_DATA = {
    "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
    "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
    "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
    "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€", "å’Œå¹³å€"],
    "å°å—å¸‚": ["ä¸­è¥¿å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å¹³å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
    "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
    "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
    "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
    "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
    "è‹—æ —ç¸£": ["è‹—æ —å¸‚", "é ­ä»½å¸‚", "ç«¹å—é®", "å¾Œé¾é®", "é€šéœ„é®", "è‹‘è£¡é®", "å“è˜­é®", "é€ æ©‹é„‰", "è¥¿æ¹–é„‰", "é ­å±‹é„‰", "å…¬é¤¨é„‰", "éŠ…é‘¼é„‰", "ä¸‰ç¾©é„‰", "å¤§æ¹–é„‰", "ç…æ½­é„‰", "ä¸‰ç£é„‰", "å—åº„é„‰", "æ³°å®‰é„‰"],
    "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "å“¡æ—å¸‚", "é¹¿æ¸¯é®", "å’Œç¾é®", "åŒ—æ–—é®", "æºªæ¹–é®", "ç”°ä¸­é®", "äºŒæ—é®", "ç·šè¥¿é„‰", "ä¼¸æ¸¯é„‰", "ç¦èˆˆé„‰", "ç§€æ°´é„‰", "èŠ±å£‡é„‰", "èŠ¬åœ’é„‰", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "åŸ”å¿ƒé„‰", "æ°¸é–é„‰", "ç¤¾é ­é„‰", "äºŒæ°´é„‰", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "èŠ³è‹‘é„‰", "å¤§åŸé„‰", "ç«¹å¡˜é„‰", "æºªå·é„‰"],
    "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "åŸ”é‡Œé®", "è‰å±¯é®", "ç«¹å±±é®", "é›†é›†é®", "åé–“é„‰", "é¹¿è°·é„‰", "ä¸­å¯®é„‰", "é­šæ± é„‰", "åœ‹å§“é„‰", "æ°´é‡Œé„‰", "ä¿¡ç¾©é„‰", "ä»æ„›é„‰"],
    "é›²æ—ç¸£": ["æ–—å…­å¸‚", "æ–—å—é®", "è™å°¾é®", "è¥¿èºé®", "åœŸåº«é®", "åŒ—æ¸¯é®", "å¤å‘é„‰", "å¤§åŸ¤é„‰", "è¿æ¡é„‰", "æ—å…§é„‰", "äºŒå´™é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ±å‹¢é„‰", "è¤’å¿ é„‰", "å°è¥¿é„‰", "å…ƒé•·é„‰", "å››æ¹–é„‰", "å£æ¹–é„‰", "æ°´æ—é„‰"],
    "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
    "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚", "æœ´å­å¸‚", "å¸ƒè¢‹é®", "å¤§æ—é®", "æ°‘é›„é„‰", "æºªå£é„‰", "æ–°æ¸¯é„‰", "å…­è…³é„‰", "æ±çŸ³é„‰", "ç¾©ç«¹é„‰", "é¹¿è‰é„‰", "æ°´ä¸Šé„‰", "ä¸­åŸ”é„‰", "ç«¹å´é„‰", "æ¢…å±±é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±é„‰"],
    "å±æ±ç¸£": ["å±æ±å¸‚", "æ½®å·é®", "æ±æ¸¯é®", "æ†æ˜¥é®", "è¬ä¸¹é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é«˜æ¨¹é„‰", "é¹½åŸ”é„‰", "å…§åŸ”é„‰", "ç«¹ç”°é„‰", "è¬å·’é„‰", "æ‹å¯®é„‰", "æ–°åŸ¤é„‰", "æ‹å±±é„‰", "è»ŠåŸé„‰", "æ»¿å·é„‰", "ç‰çƒé„‰", "ä¸‰åœ°é–€é„‰", "éœ§è‡ºé„‰", "ç‘ªå®¶é„‰", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "ç‰¡ä¸¹é„‰"],
    "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "ç¾…æ±é®", "è˜‡æ¾³é®", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "å†¬å±±é„‰", "äº”çµé„‰", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "å—æ¾³é„‰"],
    "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "é³³æ—é®", "ç‰é‡Œé®", "æ–°åŸé„‰", "å‰å®‰é„‰", "å£½è±é„‰", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "å¯Œé‡Œé„‰", "ç§€æ—é„‰", "è¬æ¦®é„‰", "å“æºªé„‰"],
    "å°æ±ç¸£": ["å°æ±å¸‚", "æˆåŠŸé®", "é—œå±±é®", "å‘å—é„‰", "é¹¿é‡é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "å¤§æ­¦é„‰", "ç¶ å³¶é„‰", "æµ·ç«¯é„‰", "å»¶å¹³é„‰", "é‡‘å³°é„‰", "é”ä»é„‰", "è˜­å¶¼é„‰"],
    "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"],
    "é‡‘é–€ç¸£": ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
    "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
}

# --- 2. æ ¸å¿ƒåˆå§‹åŒ– (è‡ªå‹•åµæ¸¬å¯ç”¨è·¯å¾‘ï¼Œå¾¹åº•é¿é–‹ 404) ---
st.set_page_config(page_title="æ¨‚ç¦é›†åœ˜ï¼šå…¨å°é‡‘ç‰Œåµå¯Ÿç³»çµ±", layout="wide", page_icon="ğŸ¦…")

@st.cache_resource
def get_model():
    api_key = st.secrets.get("GEMINI_API_KEY")
    if not api_key:
        st.error("âŒ æ‰¾ä¸åˆ° API é‡‘é‘°ã€‚")
        return None
    genai.configure(api_key=api_key)
    
    try:
        # ã€è‡ªå‹•åµæ¸¬æ©Ÿåˆ¶ã€‘: æ‰¾å‡ºç›®å‰å¸³è™ŸçœŸæ­£èƒ½ç”¨çš„æ¨¡å‹å®Œæ•´è·¯å¾‘
        models = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        
        # å„ªå…ˆé †åºï¼š1.5-flash -> 1.0-pro
        selected_model = ""
        if 'models/gemini-1.5-flash' in models:
            selected_model = 'models/gemini-1.5-flash'
        elif 'models/gemini-pro' in models:
            selected_model = 'models/gemini-pro'
        else:
            selected_model = models[0] if models else ""

        if not selected_model:
            st.error("æ­¤ API Key ç„¡å¯ç”¨æ¨¡å‹ã€‚")
            return None

        return genai.GenerativeModel(
            model_name=selected_model,
            system_instruction="ä½ ç¾åœ¨æ˜¯ã€æ¨‚ç¦é›†åœ˜ã€‘é‡‘ç‰Œæ•™ç·´ã€‚ä½ å°å…¨å°åœ°æ®µèˆ‡åªæ•¸æ¥µå…¶å°ˆæ¥­ï¼Œèªæ°£çŠ€åˆ©ä¸”éœ¸æ°£ã€‚"
        )
    except Exception as e:
        st.error(f"é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèª API é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚éŒ¯èª¤ï¼š{e}")
        return None

model = get_model()

# --- 3. ä»‹é¢è¨­è¨ˆ ---
st.title("ğŸ¦… æ¨‚ç¦é›†åœ˜ï¼šå…¨å°é‡‘ç‰Œåµå¯Ÿä½œæˆ°ç³»çµ±")
st.markdown("---")

# å®Œæ•´åœ°å€å€åŸŸ
st.subheader("ğŸ“ 1. è©³ç´°ç‰©ä»¶åœ°å€")
a1, a2, a3 = st.columns([2, 2, 4])
with a1: sel_city = st.selectbox("ç¸£å¸‚", options=list(TAIWAN_DATA.keys()), index=3)
with a2: sel_dist = st.selectbox("å€åŸŸ", options=TAIWAN_DATA[sel_city])
with a3: road_name = st.text_input("è·¯è¡—å", placeholder="ä¾‹å¦‚ï¼šå´‡å¾·è·¯")

# å··å¼„å¼„è™Ÿæ¨“å®Œæ•´æ ¼å¼
b1, b2, b3, b4, b5, b6 = st.columns([1, 1, 1, 1, 1, 2])
with b1: addr_lane = st.text_input("å··")
with b2: addr_alley = st.text_input("å¼„")
with b3: addr_sub = st.text_input("è¡–")
with b4: addr_sec = st.text_input("æ®µ")
with b5: addr_num = st.text_input("è™Ÿ")
with b6: addr_floor = st.text_input("æ¨“å±¤")

with st.form("love_pro_master_form"):
    c_name = st.text_input("ğŸ  æ¡ˆå/ç¤¾å€åç¨±")
    st.divider()

    # åªæ•¸ç´°é …ï¼šç©ºç™½è‡ªç”±è¼¸å…¥æ¡†
    st.subheader("ğŸ“ 2. å»ºç‰©åªæ•¸æ‹†è§£ (ç©ºç™½è‡ªç”±è¼¸å…¥)")
    p1, p2, p3, p4 = st.columns(4)
    with p1:
        c_main = st.text_input("ğŸ  ä¸»å»ºç‰©åªæ•¸")
        c_sub = st.text_input("â• é™„å±¬å»ºç‰©")
    with p2:
        c_public = st.text_input("ğŸ¢ å…¬è¨­åªæ•¸")
        c_parking = st.text_input("ğŸš— è»Šä½åªæ•¸")
    with p3:
        c_total = st.text_input("ğŸ“Š æ¬Šç‹€ç¸½åªæ•¸")
        c_land = st.text_input("ğŸŒ± æŒåˆ†åœ°åª")
    with p4:
        c_floor_all = st.text_input("ğŸ¢ ç¸½æ¨“é«˜")
        c_price = st.text_input("ğŸ’° ç¸½é–‹åƒ¹")

    st.divider()

    # å°ˆæ¥­æŒ‡æ¨™
    f1, f2, f3 = st.columns(3)
    with f1:
        c_age = st.text_input("ğŸ“… å±‹é½¡")
        c_layout = st.text_input("ğŸ›ï¸ æ ¼å±€")
    with f2:
        c_face = st.selectbox("æœå‘", ["åº§åŒ—æœå—", "åº§å—æœåŒ—", "åº§æ±æœè¥¿", "åº§è¥¿æœæ±", "å…¶ä»–"])
        c_status = st.selectbox("å±‹æ³", ["å…¨æ–°æ•´ç†", "ç¾æ³è‡ªä½", "éœ€å¤§æ•´ç†", "æ¯›èƒšå±‹"])
    with f3:
        c_road = st.text_input("ğŸ›£ï¸ è·¯å¯¬/é¢å¯¬")
        c_agent = st.text_input("ğŸ‘¤ æ¨‚ç¦æˆ°é¬¥å“¡å§“å")

    submitted = st.form_submit_button("ğŸ”¥ å•Ÿå‹•æ¨‚ç¦é‡‘ç‰Œæ·±åº¦åˆ†æ")

# --- 4. åˆ†æå ±å‘Š ---
if submitted:
    if not model:
        st.error("API æœªå•Ÿå‹•ã€‚")
    else:
        full_addr = f"{sel_city}{sel_dist}{road_name}{addr_lane}å··{addr_alley}å¼„{addr_sub}è¡–{addr_sec}æ®µ{addr_num}è™Ÿ{addr_floor}"
        with st.spinner("ğŸ¯ æ­£åœ¨ç²¾ç®—ä¸­..."):
            try:
                prompt = f"ç¶“ç´€äººï¼š{c_agent} (æ¨‚ç¦é›†åœ˜)ã€‚åœ°å€ï¼š{full_addr}ã€‚ç¸½å»ºï¼š{c_total}ã€‚ä¸»é™„å…¬ï¼š{c_main}/{c_sub}/{c_public}ã€‚è«‹ä»¥é‡‘ç‰Œæ•™ç·´èº«åˆ†çµ¦äºˆæ·±åº¦æˆ°ç•¥ã€‚"
                response = model.generate_content(prompt)
                st.markdown(f"### ğŸ“‹ {c_agent} å°ˆå±¬å ±å‘Š")
                st.markdown(response.text)
            except Exception as e:
                st.error(f"åˆ†æå¤±æ•—ï¼š{e}")
