import streamlit as st
import google.generativeai as genai
import streamlit.components.v1 as components
import urllib.parse

# --- 1. å…¨å°å®Œæ•´è¡Œæ”¿å€èˆ‡éƒµéå€è™Ÿè³‡æ–™åº« ---
POSTAL_DATA = {
    "è‡ºä¸­å¸‚": {"ä¸­å€": "400", "æ±å€": "401", "å—å€": "402", "è¥¿å€": "403", "åŒ—å€": "404", "åŒ—å±¯å€": "406", "è¥¿å±¯å€": "407", "å—å±¯å€": "408", "å¤ªå¹³å€": "411", "å¤§é‡Œå€": "412", "éœ§å³°å€": "413", "çƒæ—¥å€": "414", "è±åŸå€": "420", "åé‡Œå€": "421", "çŸ³å²¡å€": "422", "æ±å‹¢å€": "423", "æ–°ç¤¾å€": "424", "æ½­å­å€": "427", "å¤§é›…å€": "428", "ç¥å²¡å€": "429", "å¤§è‚šå€": "432", "æ²™é¹¿å€": "433", "é¾äº•å€": "434", "æ¢§æ£²å€": "435", "æ¸…æ°´å€": "436", "å¤§ç”²å€": "437", "å¤–åŸ”å€": "438", "å¤§å®‰å€": "439", "å’Œå¹³å€": "426"},
    "è‡ºåŒ—å¸‚": {"ä¸­æ­£å€": "100", "å¤§åŒå€": "103", "ä¸­å±±å€": "104", "æ¾å±±å€": "105", "å¤§å®‰å€": "106", "è¬è¯å€": "108", "ä¿¡ç¾©å€": "110", "å£«æ—å€": "111", "åŒ—æŠ•å€": "112", "å…§æ¹–å€": "114", "å—æ¸¯å€": "115", "æ–‡å±±å€": "116"},
    "æ–°åŒ—å¸‚": {"æ¿æ©‹å€": "220", "ä¸‰é‡å€": "241", "ä¸­å’Œå€": "235", "æ°¸å’Œå€": "234", "æ–°èŠå€": "242", "æ–°åº—å€": "231", "æ¨¹æ—å€": "238", "é¶¯æ­Œå€": "239", "ä¸‰å³½å€": "237", "æ·¡æ°´å€": "251", "æ±æ­¢å€": "221", "åœŸåŸå€": "236", "è˜†æ´²å€": "247", "äº”è‚¡å€": "248", "æ³°å±±å€": "243", "æ—å£å€": "244", "æ·±å‘å€": "222", "çŸ³ç¢‡å€": "223", "åªæ—å€": "224", "ä¸‰èŠå€": "252", "çŸ³é–€å€": "253", "å…«é‡Œå€": "249", "å¹³æºªå€": "226", "é›™æºªå€": "227", "è²¢å¯®å€": "228", "é‡‘å±±å€": "208", "è¬é‡Œå€": "207", "çƒä¾†å€": "233"},
    "æ¡ƒåœ’å¸‚": {"æ¡ƒåœ’å€": "330", "ä¸­å£¢å€": "320", "å¤§æºªå€": "335", "æ¥Šæ¢…å€": "326", "è˜†ç«¹å€": "338", "å¤§åœ’å€": "337", "é¾œå±±å€": "333", "å…«å¾·å€": "334", "é¾æ½­å€": "325", "å¹³é®å€": "324", "æ–°å±‹å€": "327", "è§€éŸ³å€": "328", "å¾©èˆˆå€": "336"},
    "è‡ºå—å¸‚": {"ä¸­è¥¿å€": "700", "æ±å€": "701", "å—å€": "702", "åŒ—å€": "704", "å®‰å¹³å€": "708", "å®‰å—å€": "709", "æ°¸åº·å€": "710", "æ­¸ä»å€": "711", "æ–°åŒ–å€": "712", "å·¦é®å€": "713", "ç‰äº•å€": "714", "æ¥ è¥¿å€": "715", "å—åŒ–å€": "716", "ä»å¾·å€": "717", "é—œå»Ÿå€": "718", "é¾å´å€": "719", "å®˜ç”°å€": "720", "éº»è±†å€": "721", "ä½³é‡Œå€": "722", "è¥¿æ¸¯å€": "723", "ä¸ƒè‚¡å€": "724", "å°‡è»å€": "725", "å­¸ç”²å€": "726", "åŒ—é–€å€": "727", "æ–°ç‡Ÿå€": "730", "å¾Œå£å€": "731", "ç™½æ²³å€": "732", "æ±å±±å€": "733", "å…­ç”²å€": "734", "ä¸‹ç‡Ÿå€": "735", "æŸ³ç‡Ÿå€": "736", "é¹½æ°´å€": "737", "å–„åŒ–å€": "741", "å¤§å…§å€": "742", "å±±ä¸Šå€": "743", "æ–°å¸‚å€": "744", "å®‰å®šå€": "745"},
    "é«˜é›„å¸‚": {"æ–°èˆˆå€": "800", "å‰é‡‘å€": "801", "è‹“é›…å€": "802", "é¹½åŸ•å€": "803", "é¼“å±±å€": "804", "æ——æ´¥å€": "805", "å‰é®å€": "806", "ä¸‰æ°‘å€": "807", "æ¥ æ¢“å€": "808", "å°æ¸¯å€": "812", "å·¦ç‡Ÿå€": "813", "ä»æ­¦å€": "814", "å¤§ç¤¾å€": "815", "å²¡å±±å€": "820", "è·¯ç«¹å€": "821", "é˜¿è“®å€": "822", "ç”°å¯®å€": "823", "ç‡•å·¢å€": "824", "æ©‹é ­å€": "825", "æ¢“å®˜å€": "826", "å½Œé™€å€": "827", "æ°¸å®‰å€": "828", "æ¹–å…§å€": "829", "é³³å±±å€": "830", "å¤§å¯®å€": "831", "æ—åœ’å€": "832", "é³¥æ¾å€": "833", "å¤§æ¨¹å€": "834", "æ——å±±å€": "840", "ç¾æ¿ƒå€": "842", "å…­é¾œå€": "844", "å…§é–€å€": "845", "æ‰æ—å€": "846", "ç”²ä»™å€": "847", "æ¡ƒæºå€": "848", "é‚£ç‘ªå¤å€": "849", "èŒ‚æ—å€": "851", "èŒ„è£å€": "852"},
    "åŸºéš†å¸‚": {"ä»æ„›å€": "200", "ä¿¡ç¾©å€": "201", "ä¸­æ­£å€": "202", "ä¸­å±±å€": "203", "å®‰æ¨‚å€": "204", "æš–æš–å€": "205", "ä¸ƒå µå€": "206"},
    "æ–°ç«¹å¸‚": {"æ±å€": "300", "åŒ—å€": "300", "é¦™å±±å€": "300"},
    "æ–°ç«¹ç¸£": {"ç«¹åŒ—å¸‚": "302", "ç«¹æ±é®": "310", "æ–°åŸ”é®": "305", "é—œè¥¿é®": "306", "æ¹–å£é„‰": "303", "æ–°è±é„‰": "304", "èŠæ—é„‰": "307", "æ©«å±±é„‰": "312", "åŒ—åŸ”é„‰": "314", "å¯¶å±±é„‰": "308", "å³¨çœ‰é„‰": "315", "å°–çŸ³é„‰": "313", "äº”å³°é„‰": "311"},
    "è‹—æ —ç¸£": {"è‹—æ —å¸‚": "360", "é ­ä»½å¸‚": "351", "ç«¹å—é®": "350", "å¾Œé¾é®": "356", "é€šéœ„é®": "357", "è‹‘è£¡é®": "358", "å“è˜­é®": "369", "é€ æ©‹é„‰": "361", "è¥¿æ¹–é„‰": "368", "é ­å±‹é„‰": "362", "å…¬é¤¨é„‰": "363", "éŠ…é‘¼é„‰": "366", "ä¸‰ç¾©é„‰": "367", "å¤§æ¹–é„‰": "364", "ç…æ½­é„‰": "354", "ä¸‰ç£é„‰": "352", "å—åº„é„‰": "353", "æ³°å®‰é„‰": "365"},
    "å½°åŒ–ç¸£": {"å½°åŒ–å¸‚": "500", "å“¡æ—å¸‚": "510", "é¹¿æ¸¯é®": "505", "å’Œç¾é®": "508", "åŒ—æ–—é®": "521", "æºªæ¹–é®": "514", "ç”°ä¸­é®": "520", "äºŒæ—é®": "526", "ç·šè¥¿é„‰": "507", "ä¼¸æ¸¯é„‰": "509", "ç¦èˆˆé„‰": "506", "ç§€æ°´é„‰": "504", "èŠ±å£‡é„‰": "503", "èŠ¬åœ’é„‰": "502", "å¤§æ‘é„‰": "515", "åŸ”é¹½é„‰": "516", "åŸ”å¿ƒé„‰": "513", "æ°¸é–é„‰": "512", "ç¤¾é ­é„‰": "511", "äºŒæ°´é„‰": "530", "ç”°å°¾é„‰": "522", "åŸ¤é ­é„‰": "523", "èŠ³è‹‘é„‰": "528", "å¤§åŸé„‰": "527", "ç«¹å¡˜é„‰": "525", "æºªå·é„‰": "524"},
    "å—æŠ•ç¸£": {"å—æŠ•å¸‚": "540", "åŸ”é‡Œé®": "545", "è‰å±¯é®": "542", "ç«¹å±±é®": "557", "é›†é›†é®": "552", "åé–“é„‰": "551", "é¹¿è°·é„‰": "558", "ä¸­å¯®é„‰": "541", "é­šæ± é„‰": "555", "åœ‹å§“é„‰": "544", "æ°´é‡Œé„‰": "553", "ä¿¡ç¾©é„‰": "556", "ä»æ„›é„‰": "546"},
    "é›²æ—ç¸£": {"æ–—å…­å¸‚": "640", "æ–—å—é®": "630", "è™å°¾é®": "632", "è¥¿èºé®": "648", "åœŸåº«é®": "633", "åŒ—æ¸¯é®": "651", "å¤å‘é„‰": "646", "å¤§åŸ¤é„‰": "631", "è¿æ¡é„‰": "647", "æ—å…§é„‰": "643", "äºŒå´™é„‰": "649", "å´™èƒŒé„‰": "637", "éº¥å¯®é„‰": "638", "æ±å‹¢é„‰": "635", "è¤’å¿ é„‰": "634", "å°è¥¿é„‰": "636", "å…ƒé•·é„‰": "655", "å››æ¹–é„‰": "654", "å£æ¹–é„‰": "653", "æ°´æ—é„‰": "652"},
    "å˜‰ç¾©å¸‚": {"æ±å€": "600", "è¥¿å€": "600"},
    "å˜‰ç¾©ç¸£": {"å¤ªä¿å¸‚": "612", "æœ´å­å¸‚": "613", "å¸ƒè¢‹é®": "625", "å¤§æ—é®": "622", "æ°‘é›„é„‰": "621", "æºªå£é„‰": "623", "æ–°æ¸¯é„‰": "616", "å…­è…³é„‰": "615", "æ±çŸ³é„‰": "614", "ç¾©ç«¹é„‰": "624", "é¹¿è‰é„‰": "611", "æ°´ä¸Šé„‰": "608", "ä¸­åŸ”é„‰": "606", "ç«¹å´é„‰": "604", "æ¢…å±±é„‰": "603", "ç•ªè·¯é„‰": "602", "å¤§åŸ”é„‰": "607", "é˜¿é‡Œå±±é„‰": "605"},
    "å±æ±ç¸£": {"å±æ±å¸‚": "900", "æ½®å·é®": "920", "æ±æ¸¯é®": "928", "æ†æ˜¥é®": "946", "è¬ä¸¹é„‰": "913", "é•·æ²»é„‰": "908", "éºŸæ´›é„‰": "909", "ä¹å¦‚é„‰": "904", "é‡Œæ¸¯é„‰": "905", "é«˜æ¨¹é„‰": "906", "é¹½åŸ”é„‰": "907", "å…§åŸ”é„‰": "912", "ç«¹ç”°é„‰": "911", "è¬å·’é„‰": "923", "æ‹å¯®é„‰": "940", "æ–°åŸ¤é„‰": "925", "æ‹å±±é„‰": "941", "è»ŠåŸé„‰": "944", "æ»¿å·é„‰": "947", "ä¸‰åœ°é–€é„‰": "901", "éœ§è‡ºé„‰": "902", "ç‘ªå®¶é„‰": "903", "æ³°æ­¦é„‰": "921", "ä¾†ç¾©é„‰": "922", "æ˜¥æ—¥é„‰": "942", "ç…å­é„‰": "943", "ç‰¡ä¸¹é„‰": "945", "ç‰çƒé„‰": "929", "å´é ‚é„‰": "924", "å—å·é„‰": "926", "ä½³å†¬é„‰": "927"},
    "å®œè˜­ç¸£": {"å®œè˜­å¸‚": "260", "ç¾…æ±é®": "265", "è˜‡æ¾³é®": "270", "é ­åŸé®": "261", "ç¤æºªé„‰": "262", "å£¯åœé„‰": "263", "å“¡å±±é„‰": "264", "å†¬å±±é„‰": "269", "äº”çµé„‰": "268", "ä¸‰æ˜Ÿé„‰": "266", "å¤§åŒé„‰": "267", "å—æ¾³é„‰": "272"},
    "èŠ±è“®ç¸£": {"èŠ±è“®å¸‚": "970", "é³³æ—é®": "975", "ç‰é‡Œé®": "981", "æ–°åŸé„‰": "971", "å‰å®‰é„‰": "973", "å£½è±é„‰": "974", "å…‰å¾©é„‰": "976", "è±æ¿±é„‰": "977", "ç‘ç©—é„‰": "978", "å¯Œé‡Œé„‰": "983", "ç§€æ—é„‰": "972", "è¬æ¦®é„‰": "979", "å“æºªé„‰": "982"},
    "å°æ±ç¸£": {"å°æ±å¸‚": "950", "æˆåŠŸé®": "961", "é—œå±±é®": "962", "å‘å—é„‰": "954", "é¹¿é‡é„‰": "955", "æ± ä¸Šé„‰": "956", "æ±æ²³é„‰": "959", "é•·æ¿±é„‰": "962", "å¤ªéº»é‡Œé„‰": "963", "å¤§æ­¦é„‰": "965", "ç¶ å³¶é„‰": "951", "æµ·ç«¯é„‰": "957", "å»¶å¹³é„‰": "953", "é‡‘å³°é„‰": "964", "é”ä»é„‰": "966", "è˜­å¶¼é„‰": "952"},
    "æ¾æ¹–ç¸£": {"é¦¬å…¬å¸‚": "880", "æ¹–è¥¿é„‰": "885", "ç™½æ²™é„‰": "884", "è¥¿å¶¼é„‰": "881", "æœ›å®‰é„‰": "882", "ä¸ƒç¾é„‰": "883"},
    "é‡‘é–€ç¸£": {"é‡‘åŸé®": "893", "é‡‘æ¹–é®": "891", "é‡‘æ²™é®": "890", "é‡‘å¯§é„‰": "892", "çƒˆå¶¼é„‰": "894", "çƒåµé„‰": "896"},
    "é€£æ±Ÿç¸£": {"å—ç«¿é„‰": "209", "åŒ—ç«¿é„‰": "210", "è’å…‰é„‰": "211", "æ±å¼•é„‰": "212"}
}

# --- 2. æ ¸å¿ƒåˆå§‹åŒ– ---
st.set_page_config(page_title="æ¨‚ç¦é›†åœ˜ HOUSE MANAGER PRO", layout="wide", page_icon="ğŸ¦…")

# CSS: é«˜è³ªæ„Ÿåº•ç·šé¢¨æ ¼ + åœ°åœ–æ¡†
st.markdown("""
    <style>
    .stTextInput>div>div>input, .stSelectbox>div>div>div { background-color: transparent; border: none; border-bottom: 2px solid #1e3a8a; border-radius: 0px; padding: 5px 0px; }
    h1 { color: #1e3a8a; font-family: 'Noto Sans TC', sans-serif; font-weight: 800; }
    .section-title { color: #334155; border-left: 5px solid #1e3a8a; padding-left: 15px; margin-top: 30px; margin-bottom: 15px; font-weight: bold; font-size: 1.25rem; }
    .ai-box { background-color: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 5px solid #0ea5e9; margin-bottom: 20px; }
    .map-container { border: 2px solid #1e3a8a; border-radius: 10px; overflow: hidden; margin-top: 10px; margin-bottom: 20px;}
    
    /* è¡—æ™¯æŒ‰éˆ• */
    .street-view-btn {
        display: block;
        width: 100%;
        text-align: center;
        background-color: #FFC107;
        color: #000;
        font-weight: bold;
        padding: 10px;
        text-decoration: none;
        border-radius: 5px;
        margin-top: 5px;
    }
    .street-view-btn:hover { background-color: #ffb300; }
    </style>
    """, unsafe_allow_html=True)

@st.cache_resource
def get_model():
    api_key = st.secrets.get("GEMINI_API_KEY")
    if not api_key: return None
    genai.configure(api_key=api_key)
    try:
        models = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        target = 'models/gemini-1.5-flash' if 'models/gemini-1.5-flash' in models else models[0]
        instruction = """
        ä½ ç¾åœ¨æ˜¯æ¨‚ç¦é›†åœ˜çš„ã€é‡‘ç‰Œæˆ¿ç”¢æˆ°ç•¥æ•™ç·´ã€‘ã€‚
        ä½ çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯ï¼šã€è‡ªå‹•è¡Œæƒ…åµæŸ¥ã€‘èˆ‡ã€æ•¸æ“šæˆ°ç•¥åˆ†æã€‘ã€‚
        
        ä»»å‹™ï¼š
        1. æ ¹æ“šè¼¸å…¥çš„ç¤¾å€èˆ‡åœ°æ®µï¼Œå›æº¯ä½ çŸ¥è­˜åº«ä¸­çš„æˆäº¤è¡Œæƒ…ã€‚
        2. å°‡ã€Œæœ¬æ¡ˆé–‹åƒ¹ã€vsã€ŒAIåµæŸ¥è¡Œæƒ…ã€vsã€Œæ¨‚ç¦å…§å»ºä¼°å€¼ã€åšä¸‰è§’æ¯”å°ã€‚
        3. ç”¢å‡ºç²¾æº–çš„è­°åƒ¹ç­–ç•¥ã€‚
        """
        return genai.GenerativeModel(model_name=target, system_instruction=instruction)
    except: return None

model = get_model()

# --- 3. ä»‹é¢è¨­è¨ˆ ---
st.title("ğŸ¦… HOUSE MANAGER")
st.caption("é¼æ³°ä¸€ä¸å‹•ç”¢ç¶“ç´€æœ‰é™å…¬å¸ Â· æ¨‚ç¦é›†åœ˜ | AI å¯¦æ™¯æˆ°æƒ…ç‰ˆ")

# === A. é–€ç‰Œè³‡è¨Šèˆ‡å³æ™‚åœ°åœ– ===
st.markdown('<div class="section-title">ğŸ“ ç‰©ä»¶ä½ç½®èˆ‡å¯¦æ™¯</div>', unsafe_allow_html=True)

col_map_L, col_map_R = st.columns([1, 1])

with col_map_L:
    # åœ°å€è¼¸å…¥å€
    c1, c2 = st.columns([1, 1])
    with c1: sel_city = st.selectbox("åŸå¸‚ *", options=list(POSTAL_DATA.keys()), index=0)
    with c2: sel_dist = st.selectbox("é„‰/é®/å¸‚/å€ *", options=list(POSTAL_DATA[sel_city].keys()))
    
    # éƒµéå€è™Ÿ
    p_code = POSTAL_DATA[sel_city][sel_dist]
    
    # è·¯å
    road_name = st.text_input("è·¯/è¡— (è¼¸å…¥å¾Œåœ°åœ–é€£å‹•) *", placeholder="ä¾‹å¦‚ï¼šæ–‡å¿ƒè·¯å››æ®µ")
    
    # è©³ç´°é–€ç‰Œ
    r1, r2 = st.columns(2)
    with r1: addr_lane = st.text_input("å··")
    with r2: addr_alley = st.text_input("å¼„")
    
    r3, r4 = st.columns(2)
    with r3: addr_num = st.text_input("è™Ÿ")
    with r4: addr_floor = st.text_input("æ¨“")
    
    c_name = st.text_input("ğŸ¢ æ¡ˆå/ç¤¾å€åç¨±", placeholder="åˆ©æ–¼ AI è¾¨è­˜è¡Œæƒ…")

# çµ„åˆåœ°åœ–ç”¨åœ°å€
map_addr = f"{sel_city}{sel_dist}{road_name}"
if addr_num: map_addr += f"{addr_num}è™Ÿ"

with col_map_R:
    # åµŒå…¥ Google Map
    if road_name:
        q_url = urllib.parse.quote(map_addr)
        # åœ°åœ– iframe
        st.markdown(f"""
        <div class="map-container">
            <iframe 
                width="100%" 
                height="300" 
                frameborder="0" 
                style="border:0" 
                src="https://maps.google.com/maps?q={q_url}&output=embed" 
                allowfullscreen>
            </iframe>
        </div>
        """, unsafe_allow_html=True)
        
        # 720åº¦è¡—æ™¯æŒ‰éˆ• (é–‹å•Ÿ App)
        st.markdown(f"""
        <a href="https://www.google.com/maps/search/?api=1&query={q_url}" target="_blank" class="street-view-btn">
           ğŸ‘€ é–‹å•Ÿ 720Â° ç¾å ´å¯¦æ™¯ (Street View)
        </a>
        """, unsafe_allow_html=True)
    else:
        st.info("ğŸ‘ˆ è«‹åœ¨å·¦å´è¼¸å…¥è·¯åï¼Œåœ°åœ–å°‡è‡ªå‹•å®šä½ã€‚")

# === B. è¦æ ¼èˆ‡è‡ªå‹•åˆ†æå€ ===
with st.form("auto_market_form"):
    st.markdown('<div class="section-title">ğŸ“ ç‰©ä»¶è¦æ ¼èˆ‡å…§å»ºæª”</div>', unsafe_allow_html=True)
    
    p1, p2, p3 = st.columns(3)
    with p1: c_main = st.text_input("ğŸ  ä¸»å»ºç‰©åªæ•¸")
    with p2: c_sub = st.text_input("â• é™„å±¬å»ºç‰©")
    with p3: c_public = st.text_input("ğŸ¢ å…¬è¨­åªæ•¸")

    p4, p5, p6 = st.columns(3)
    with p4: c_total = st.text_input("ğŸ“Š æ¬Šç‹€ç¸½åªæ•¸")
    with p5: c_land = st.text_input("ğŸŒ± æŒåˆ†åœ°åª")
    with p6: c_price = st.text_input("ğŸ’° æœ¬æ¡ˆé–‹åƒ¹ (è¬)")

    st.markdown("##### ğŸ”’ å…§éƒ¨æ©Ÿå¯†æ•¸æ“š")
    i1, i2 = st.columns(2)
    with i1: internal_val = st.text_input("æ¨‚ç¦å…§å»ºä¼°å€¼ (è¬)", placeholder="å…¬å¸é‘‘åƒ¹")
    with i2: coop_status = st.text_input("åˆä½œç‹€æ³", placeholder="ä¾‹å¦‚ï¼šå°ˆä»»ã€å‹åº—åº«å­˜å¤š")

    st.markdown("---")
    f1, f2, f3 = st.columns(3)
    with f1: c_age = st.text_input("ğŸ“… å±‹é½¡")
    with f2: c_face = st.selectbox("ğŸ§­ æœå‘", ["åº§åŒ—æœå—", "åº§å—æœåŒ—", "åº§æ±æœè¥¿", "åº§è¥¿æœæ±", "å…¶ä»–"])
    with f3: c_agent = st.text_input("ğŸ‘¤ æ¨‚ç¦æˆ°é¬¥å“¡å§“å")

    # æç¤º
    st.markdown("""
    <div class="ai-box">
    ğŸ¤– <b>AI è‡ªå‹•æˆ°æƒ…å®¤</b><br>
    ç³»çµ±å°‡è‡ªå‹•æŠ“å–è©²åœ°æ®µè¡Œæƒ…ï¼Œèˆ‡é–‹åƒ¹ã€å…§å»ºä¼°å€¼é€²è¡Œä¸‰æ–¹æ¯”å°ï¼Œç”¢å‡ºä½œæˆ°å ±å‘Šã€‚
    </div>
    """, unsafe_allow_html=True)

    submitted = st.form_submit_button("ğŸ”¥ å•Ÿå‹• AI è¡Œæƒ…åµæŸ¥ & æˆ°ç•¥å ±å‘Š")

# --- 4. åŸ·è¡Œèˆ‡åˆ†æ ---
if submitted:
    if model:
        full_addr = f"{sel_city}{sel_dist}{road_name}{addr_lane+'å··' if addr_lane else ''}{addr_alley+'å¼„' if addr_alley else ''}{addr_num+'è™Ÿ' if addr_num else ''}{addr_floor+'æ¨“' if addr_floor else ''}"
        
        with st.spinner(f"ğŸ” AI æ­£åœ¨æƒæ {c_name if c_name else road_name} å‘¨é‚Šè¡Œæƒ…..."):
            try:
                prompt = f"""
                ç¶“ç´€äººï¼š{c_agent} (æ¨‚ç¦é›†åœ˜)ã€‚
                ç‰©ä»¶ï¼š{full_addr} ({c_name})ã€‚
                å±‹é½¡ï¼š{c_age}å¹´ã€‚
                
                ã€æœ¬æ¡ˆæ•¸æ“šã€‘ï¼š
                é–‹åƒ¹ï¼š{c_price}è¬ / ç¸½åªï¼š{c_total} / ä¸»+é™„ï¼š{c_main}+{c_sub}ã€‚
                æ¨‚ç¦å…§å»ºä¼°å€¼ï¼š{internal_val} è¬ã€‚
                åˆä½œç‹€æ³ï¼š{coop_status}ã€‚
                
                ã€ä»»å‹™æŒ‡ä»¤ã€‘ï¼š
                1. (AI è‡ªå‹•åµæŸ¥)ï¼šè«‹å›æº¯çŸ¥è­˜åº«ï¼Œåˆ—å‡ºè©²å€åŸŸ/ç¤¾å€çš„ã€Œé ä¼°æˆäº¤å‡åƒ¹ã€èˆ‡ã€Œè¿‘æœŸæˆäº¤å€é–“ã€ã€‚
                2. (æˆ°æƒ…æ¯”å°)ï¼šå°‡ã€ŒAI åµæŸ¥è¡Œæƒ…ã€vsã€Œæœ¬æ¡ˆé–‹åƒ¹ã€vsã€Œå…§å»ºä¼°å€¼ã€åšä¸‰è§’æ¯”å°ã€‚
                3. (æˆ°ç•¥ç”Ÿæˆ)ï¼šçµ¦å‡ºè­°åƒ¹ç­–ç•¥èˆ‡éŠ·å”®äº®é»ã€‚
                """
                response = model.generate_content(prompt)
                
                st.info(f"ğŸ“ åµæŸ¥å°è±¡ï¼š{full_addr}")
                st.markdown(response.text)
                
            except Exception as e:
                st.error(f"åˆ†æå¤±æ•—ï¼š{e}")
