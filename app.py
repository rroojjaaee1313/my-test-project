import streamlit as st
import google.generativeai as genai
import os
import json
from datetime import datetime

# --- 1. ç³»çµ±åˆå§‹åŒ– (è¨­å®šç¶²é æ¨™é¡Œèˆ‡ API) ---
st.set_page_config(page_title="è€é·¹å…¨ç¶²æ´»æ¡ˆæƒ…å ±ç«™", layout="wide", page_icon="ğŸ¦…")

try:
    if "GEMINI_API_KEY" in st.secrets:
        genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
        # ä½¿ç”¨å…·å‚™è¯ç¶²æœå°‹èƒ½åŠ›çš„æ¨¡å‹
        model = genai.GenerativeModel(model_name='gemini-1.5-flash')
    else:
        st.error("âŒ æ‰¾ä¸åˆ° API é‡‘é‘°ï¼Œè«‹æª¢æŸ¥ Streamlit Secrets è¨­å®šä¸­çš„ GEMINI_API_KEYã€‚")
        st.stop()
except Exception as e:
    st.error(f"âŒ ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦: {e}")
    st.stop()

# --- 2. ä»‹é¢è¨­è¨ˆ ---
st.title("ğŸ¦… è€é·¹åœ˜éšŠï¼šå³æ™‚åœ¨å”®ç‰©ä»¶æƒ…å ±ç³»çµ±")
st.markdown("### ğŸ” å°ˆæ³¨åµæ¸¬å„å¤§ä»²ä»‹å®˜ç¶²ã€Œç›®å‰åœ¨å”®ã€æ´»æ¡ˆï¼Œæ’é™¤å¯¦åƒ¹ç™»éŒ„ç´€éŒ„")

# åˆ†æ¬„å¸ƒå±€
col_in, col_res = st.columns([1, 1.3])

with col_in:
    st.subheader("ğŸ“ æ¡ˆä»¶æƒ…å ±è¼¸å…¥")
    with st.form("live_case_scan_form"):
        c_name = st.text_input("ğŸ  æ¡ˆä»¶/ç¤¾å€åç¨±", placeholder="ä¾‹å¦‚ï¼šå¤§é™„ä¸­åˆ¥å¢… æˆ– ç†±æ²³è·¯é€å¤©")
        c_loc = st.text_input("ğŸ“ å€åŸŸ/è·¯æ®µ", placeholder="ä¾‹å¦‚ï¼šå¤§é‡Œå€ æˆ– åŒ—å±¯å€")
        c_price = st.number_input("ğŸ’° æˆ‘çš„å§”è¨—åƒ¹æ ¼ (è¬)", value=2000, step=10)
        c_agent = st.text_input("ğŸ‘¤ æ‰¿è¾¦åŒä»å§“å")
        
        submitted = st.form_submit_button("ğŸ”¥ ç«‹å³åµæ¸¬å…¨ç¶²åŒæ¥­æ´»æ¡ˆ")

# --- 3. æ´»æ¡ˆåµæ¸¬èˆ‡ AI åˆ†æé‚è¼¯ ---
if submitted:
    if not c_name or not c_loc:
        st.error("è«‹å¡«å¯«æ¡ˆåèˆ‡å€åŸŸï¼Œä»¥åˆ©å°å¸«ç²¾æº–æœå°‹ã€‚")
    else:
        with col_res:
            with st.spinner(f"ğŸ¦… è€é·¹å°å¸«æ­£åœ¨æƒæ 5168ã€ä½å•†ã€ä¸­ä¿¡ã€å¤ªå¹³æ´‹ã€å°ç£æˆ¿å±‹ åœ¨å”®ç¶²é ..."):
                # å¼·åˆ¶ AI æœå°‹ç‰¹å®šå¹³å°çš„æ´»æ¡ˆé€£çµï¼Œåš´ç¦æä¾›å¯¦åƒ¹ç™»éŒ„èˆŠè³‡æ–™
                prompt = f"""
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æˆ¿åœ°ç”¢æƒ…å ±å“¡ã€‚ç¾åœ¨è¦é‡å°ä»¥ä¸‹ç‰©ä»¶æœå°‹ã€ç›®å‰åœ¨å¸‚å ´ä¸ŠéŠ·å”®ä¸­ã€‘çš„æ´»æ¡ˆï¼š
                æ¡ˆåï¼š{c_name} | å€åŸŸï¼š{c_loc} | é è¨ˆé–‹åƒ¹ï¼š{c_price} è¬
                
                ã€ä»»å‹™ç¡¬æ€§è¦æ±‚ã€‘ï¼š
                1. åƒ…åˆ—å‡ºç›®å‰åœ¨ã€5168ã€ä½å•†ä¸å‹•ç”¢ã€ä¸­ä¿¡æˆ¿å±‹ã€å¤ªå¹³æ´‹æˆ¿å±‹ã€å°ç£æˆ¿å±‹ã€591ã€æ°¸æ…¶ã€ä¿¡ç¾©ã€‘å®˜ç¶²ä¸Šã€Œä»åœ¨éŠ·å”®ä¸­ã€çš„ç‰©ä»¶ã€‚
                2. åš´æ ¼ã€æ’é™¤ã€‘ä»»ä½•ã€Œå¯¦åƒ¹ç™»éŒ„ã€æˆ–ã€Œå·²æˆäº¤ã€çš„æ­·å²ç¶²é ã€‚æˆ‘ä¸éœ€è¦éå»çš„ç´€éŒ„ï¼Œæˆ‘è¦çœ‹ç¾åœ¨çš„å°æ‰‹ã€‚
                3. è«‹æä¾›ã€æœ‰æ•ˆçš„åŸå§‹ç¶²é è¶…é€£çµã€‘ï¼Œæ ¼å¼å¿…é ˆç‚ºï¼š[å¹³å°åç¨± - ç‰©ä»¶æ¨™é¡Œ - ç›®å‰é–‹åƒ¹](ç¶²å€)ã€‚
                4. æœ€å¾Œè«‹åˆ†æï¼šé€™äº›ç«¶çˆ­å°æ‰‹çš„ç…§ç‰‡ç‹€æ³èˆ‡é–‹åƒ¹ï¼Œç›¸å°æ–¼æ‰¿è¾¦äºº {c_agent} çš„ {c_price} è¬ï¼Œç«¶çˆ­åŠ›å¦‚ä½•ï¼Ÿ
                """
                
                try:
                    response = model.generate_content(prompt)
                    
                    st.success("âœ… æ´»æ¡ˆæƒæå®Œæˆï¼")
                    st.markdown("### ğŸ ç•¶å‰å¸‚å ´åœ¨å”®ç«¶å“æ¸…å–® (å«ç›´æ¥é€£çµ)")
                    st.markdown(response.text)
                    
                    st.divider()
                    st.subheader("ğŸŒ å³æ™‚æœå°‹è¼”åŠ©å·¥å…·")
                    st.write("è‹¥ AI æä¾›çš„é€£çµå·²å”®ç½„ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œã€å¼·åˆ¶å…¨ç¶²å³æ™‚ç›£æ¸¬ã€‘ï¼š")
                    
                    # çµ„åˆå„å¤§ä»²ä»‹å®˜ç¶²
