import streamlit as st
import google.generativeai as genai
from google.generativeai.types import RequestOptions

# --- 1. åˆå§‹åŒ–èˆ‡å…¨å°è¡Œæ”¿å€ (ä¿æŒé€£å‹•åŠŸèƒ½) ---
TAIWAN_CITIES = {
    "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€", "å’Œå¹³å€"],
    "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
    "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
    "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
    "å°å—å¸‚": ["ä¸­è¥¿å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å¹³å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
    "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
}

st.set_page_config(page_title="æ¨‚ç¦é›†åœ˜ï¼šé‡‘ç‰Œåµå¯Ÿç³»çµ±", layout="wide", page_icon="ğŸ¦…")

@st.cache_resource
def get_model():
    api_key = st.secrets.get("GEMINI_API_KEY")
    if not api_key:
        st.error("âŒ æ‰¾ä¸åˆ° API é‡‘é‘°ã€‚")
        return None
    
    # é…ç½® API
    genai.configure(api_key=api_key)
    
    try:
        # ã€æ ¸å¿ƒä¿®å¾©ã€‘å¼·åˆ¶ä½¿ç”¨ v1 ç‰ˆæœ¬ï¼Œé¿é–‹ v1beta å°è‡´çš„ NotFound éŒ¯èª¤
        model = genai.GenerativeModel(
            model_name='models/gemini-1.5-flash',
            system_instruction="ä½ ç¾åœ¨æ˜¯æ¨‚ç¦é›†åœ˜é‡‘ç‰Œæ•™ç·´ã€‚ä½ å°åªæ•¸æ‹†è§£èˆ‡å…¨å°åœ°æ®µæ¥µå…¶æ•æ„Ÿï¼Œèªæ°£å°ˆæ¥­ä¸”çŠ€åˆ©ã€‚"
        )
        return model
    except Exception as e:
        st.error(f"æ¨¡å‹åˆå§‹åŒ–å¤±æ•—ï¼š{e}")
        return None

model = get_model()

# --- 2. ä»‹é¢è¨­è¨ˆ ---
st.title("ğŸ¦… æ¨‚ç¦é›†åœ˜ï¼šé‡‘ç‰Œåµå¯Ÿç³»çµ± (æœ€çµ‚ä¿®å¾©ç‰ˆ)")

# åœ°å€é€£å‹• (Form å¤–)
st.subheader("ğŸ“ è©³ç´°ç‰©ä»¶åœ°å€")
a1, a2, a3, a4, a5, a6 = st.columns([1.5, 1.5, 2, 1, 1, 1.5])
with a1: sel_city = st.selectbox("ç¸£å¸‚", options=list(TAIWAN_CITIES.keys()), index=0)
with a2: sel_dist = st.selectbox("é„‰é®å¸‚å€", options=TAIWAN_CITIES.get(sel_city, ["è«‹é¸æ“‡"]))
with a3: road_name = st.text_input("è·¯è¡—å", placeholder="ä¾‹å¦‚ï¼šå´‡å¾·è·¯")
with a4: addr_sec = st.text_input("æ®µ", placeholder="ä¾‹å¦‚ï¼šä¸‰")
with a5: addr_num = st.text_input("è™Ÿ", placeholder="ä¾‹å¦‚ï¼š100")
with a6: addr_floor = st.text_input("æ¨“å±¤", placeholder="ä¾‹å¦‚ï¼š12æ¨“ä¹‹1")

with st.form("love_pro_form"):
    c_name = st.text_input("ğŸ  æ¡ˆå/ç¤¾å€åç¨± (é¸å¡«)")
    st.divider()
    
    st.subheader("ğŸ“ å»ºç‰©åªæ•¸æ‹†è§£ (ç©ºç™½è™•è‡ªç”±è¼¸å…¥)")
    p1, p2, p3, p4 = st.columns(4)
    with p1: 
        c_main = st.text_input("ğŸ  ä¸»å»ºç‰©åªæ•¸")
        c_sub = st.text_input("â• é™„å±¬å»ºç‰©")
    with p2:
        c_public = st.text_input("ğŸ¢ å…¬è¨­åªæ•¸")
        c_parking = st.text_input("ğŸš— è»Šä½åªæ•¸")
    with p3:
        c_total = st.text_input("ğŸ“Š æ¬Šç‹€ç¸½å»ºåª")
        c_land = st.text_input("ğŸŒ± æŒåˆ†åœ°åª")
    with p4:
        c_floor_info = st.text_input("ğŸ¢ ç¸½æ¨“é«˜")
        c_price = st.text_input("ğŸ’° ç¸½é–‹åƒ¹")

    st.divider()
    st.subheader("ğŸ’¡ æ¨‚ç¦å°ˆæ¥­æˆ°è¡“æŒ‡æ¨™")
    f1, f2, f3 = st.columns(3)
    with f1:
        c_age = st.text_input("ğŸ“… å±‹é½¡")
        c_layout = st.text_input("ğŸ›ï¸ æ ¼å±€")
    with f2:
        c_face = st.selectbox("ğŸ§­ æœå‘", ["åº§åŒ—æœå—", "åº§å—æœåŒ—", "åº§æ±æœè¥¿", "åº§è¥¿æœæ±", "å…¶ä»–"])
        c_status = st.selectbox("ğŸ› ï¸ å±‹æ³", ["å…¨æ–°æ•´ç†", "ç¾æ³è‡ªä½", "éœ€å¤§æ•´ç†", "æ¯›èƒšå±‹"])
    with f3:
        c_road = st.text_input("ğŸ›£ï¸ è·¯å¯¬/é¢å¯¬")
        c_agent = st.text_input("ğŸ‘¤ æ¨‚ç¦æˆ°é¬¥å“¡å§“å")

    submitted = st.form_submit_button("ğŸ”¥ å•Ÿå‹•é‡‘ç‰Œæˆ°ç•¥åˆ†æå ±å‘Š")

# --- 3. åˆ†æé‚è¼¯ (åŠ å…¥å¼·åˆ¶ç‰ˆæœ¬é¸æ“‡) ---
if submitted and model:
    full_addr = f"{sel_city}{sel_dist}{road_name}{addr_sec}æ®µ{addr_num}è™Ÿ{addr_floor}"
    
    with st.spinner("ğŸ¯ æ¨‚ç¦æ•™ç·´æ­£åœ¨é€²è¡Œæ·±åº¦æ‹†è§£..."):
        try:
            prompt = f"ç¶“ç´€äººï¼š{c_agent} (æ¨‚ç¦é›†åœ˜)ã€‚ç‰©ä»¶åœ°å€ï¼š{full_addr}ã€‚ç¸½å»ºåªï¼š{c_total}ã€‚è«‹çµ¦äºˆå°ˆæ¥­æˆ°ç•¥åˆ†æã€‚"
            
            # ã€æ ¸å¿ƒä¿®å¾©ã€‘åœ¨ç™¼é€è«‹æ±‚æ™‚ï¼Œå¼·åˆ¶æŒ‡å®š API ç‰ˆæœ¬ç‚º v1
            response = model.generate_content(
                prompt,
                options=RequestOptions(api_version='v1')
            )
            
            st.markdown(f"### ğŸ“‹ {c_agent} å°ˆå±¬ä½œæˆ°å ±å‘Š")
            st.markdown(response.text)
        except Exception as e:
            st.error(f"åˆ†æå¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯ï¼š{e}")
            st.info("ğŸ’¡ å¦‚æœä¾ç„¶å‡ºç¾ 404ï¼Œè«‹ç¢ºèªæ‚¨çš„ API é‡‘é‘°æ˜¯åœ¨ Google AI Studio ç”³è«‹çš„æœ€æ–°ç‰ˆæœ¬ã€‚")
